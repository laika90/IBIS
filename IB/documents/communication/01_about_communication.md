# About Communication

## なんこれ

シリアル（じゃないかもしれない）通信の規格について全くわからなかったので、調べてわかったことをまとめていきます。完全に自己満足。多分自分で調べたほうが早いと思うよ。

## 通信規格とは

通信のやり方にもいろいろあります。  

プログラミングにおける言語（C/C++, C#, python, java, Rust...）だとか、プロトコル（HTTP, SSH...）だとか、SNSやブラウザですら用途や利点欠点で使い分けますよね。
通信も、同じでした。名前がややこしいだけで、利点欠点を踏まえて使い分けてるにすぎません。と、素人ながらに思いました。

これからは主にシリアル通信について書いていきます。  

そもそも、「通信」とは、「データを送受信すること」であり、この通信の方法の一種として、「シリアル通信」と「パラレル通信」の2種類があります。  

シリアル通信とは、
> 電気通信において伝送路上を一度に1ビットずつ、逐次的にデータを送ることをいう。また、コンピュータにおいては、バス上を一度に1ビットずつ、逐次的にデータを送ることをいう。（wikipediaより）

ということ指し、対照的にパラレル通信とは、
> 複数のデータ信号を同時並列的にそれぞれの通信リンクで送る通信方式である。一般に有線で複数の配線を使って行う。対義語はシリアル通信であり、通信リンクの特性の分類法の1つである。（wikipediaより）

を指すらしいです。要するに、シリアル通信はデータを1bitずつ送受信するのに対し、パラレル通信はデータを一気に複数送受信する、ことを指します。

<details><summary>パラレル通信の方が強くね？（折りたたみ）</summary>  

</br>  

全くもってそんなことはないです。  

パラレル通信のここがダメ！！  
* 配線が大変
* コスト高い
* 同期が大変
* それぞれの信号をそれぞれのラインで待つ必要があるので、実はタイムロス（律速段階みたいな）
* 回線の形状とか長さとかで各ラインでの通信速度に差がでる

など、色々あるので（もちろんメリットもたくさんありますが。）一般にはシリアル通信をするのが人気なようです。

</details>  

</br>

## シリアル通信のおはなし

シリアル通信にはタイプが二種類あり、全体像はこんな感じになっています。

```
通信規格
│
├── シリアル通信 
│       ├── 同期式      I2C, SPI
│       └── 非同期式    UART
│
└── パラレル通信         ISA
```

つまり、シリアル通信には「同期式」と「非同期式」の二種類があるんですね。  

これが分かれば、あとは各規格（I2CとかSPIとかUARTとか）がそれぞれどのようにデータを送受信しているかを見れば良いわけですね。

## ちょっと前提

用語の確認です。

わかる人は読み飛ばしてください。

<details><summary>シリアル通信って今回いつ使うん？</summary>

</br>

そもそもこのシリアル通信は、親機（マスター）と子機（スレーブ）の間で行うのが一般的、だと思います。

（とはいってもこれは通信の規格によるので、UARTなどの場合は両者は完全に対等です）

今回のドローン作成にあたっては、マスターがマイコン（Raspberrypi Pico）に相当し、各種センサやモジュールがスレーブに対応します。各種センサは当たり前ですがセンサとして機能するので、電気を流して指示を出せば、センサとしての機能（気圧なら気圧を。地磁気なら地磁気を測ってくれる）を果たせます。この指示自体は人間がプログラミングによって書き、この指示を電気信号に変換して各種センサに実際に指示を出しれくれるのがマイコンです。なので、せっかくマイコンにプログラミングのファイルを教えても、マイコンとセンサがどうにかして繋がっていないと、値の取得ができませんし、ことドローンに関してはセンサから各種値をリアルタイムで活用して姿勢のコントロールをするので、墜落確定演出です。と、いうわけで、このマイコン（マスター）と各種センサ（スレーブ）の間でデータをやりとりする通信を考えなければならず、どの通信方法を選択するかに伴って回路の構成も違ってきます。

</details>

</br>

<details><summary>同期</summary>

</br>

> デジタル通信において、信号線で1(H)と0(L)からなる信号の列を順に送る場合、ある信号と、次の信号の境目のタイミングを伝える方法が重要になります。信号の送り手と受け手が、信号の境目のタイミングを共有することを同期といいます。同期のためのクロック信号用の信号線を、情報送信用の信号線とは別に設けて同期をとる方式をクロック同期といいます。（[しなぷすのハード製作記](https://synapse.kyoto/glossary/clock_doki/page001.html)より）

つまり、データ送信側と受信側がデータの区切りをちゃんとわかるようにしないと、どこからどこまでがどのデータなのかわからなくなってしまうので、このデータ区切りのタイミングを送信側と受信側で合わせなければいけません。これを「同期」というわけです。

例えば、シリアル通信において、...0101110101010010...という信号が来たとして、データの一区切りを1byte(=8bit、0or1が8つで1単位ということ)としている場合、このデータを
* ... < 01011101 > < 01010010 > ...
* ...0101 > < 11010101 > < 0010...  

で捉えるかによってもデータは変わってしまいます。なので、データがどこで始まって、どこで終わるのか、をどうにかして知る必要があります。この方法にクロックを用いるのが「クロック同期」と呼ばれる方法ですが、方法はどうあれ、この境目のタイミングを共有することを「同期」と呼びます。

</details>

</br>

<details><summary>クロック</summary>

</br>

> クロック信号（クロックしんごう、クロックパルス、クロック、clock signal）とは、クロック同期設計の論理回路が動作する時に複数の回路間でタイミングを合わせる（同期を取る）ために使用される、電圧が高い状態と低い状態を周期的にとる信号である。  
> 最も典型的なクロック信号はデューティ比50%の矩形波で、一定の周波数を保つ。クロック信号により同期をとる回路は信号の立ち上がりの部分（電圧が低い状態から高い状態に遷移する部分）で動作することが多く... (wikipediaより)

おそらくraspberrypiによるクロックも「デューティ比50%の矩形波」でしょう。なので、

<img src=https://github.com/laika90/b2multicopter/blob/document/documents/communication/images/01_01.png width="600px">  

([通信用語の基礎](https://www.wdic.org/w/SCI/%E7%9F%A9%E5%BD%A2%E6%B3%A2)より引用)

こんな感じな電圧信号がraspberrypiのクロックとして使われるのでしょう。  

マイコンがこのような矩形波をデータとは別に送ることで、この矩形波の信号の立ち上がり部分でデータの区切りを判別するわけですね。  

</details>

</br>

<details><summary>情報の単位（1bitとか1byteとか）</summary>

</br>

1bitとか1byteとかよく聞きますね。

1bitは情報の最小単位で、0か1かの2つの状態を表すのが1bitです。つまり、2進数の1桁分に相当するのが1bitです。ですから、1bitあれば2つの状態を表せますね。

> 1ビットの情報は、二進数の1桁として論理値を表し、2つの値のうち1つのみを持つ。2つの状態を持つ何らかの機構によって物理的に実装できる。この状態値は、最も一般的には「0」/「1」として表されるが、真/偽 (True/False)、yes/no、+/-、on/offなどの他の表現も可能である。この値と実際の物理的状態との対応は慣習の問題であり、同じデバイスやプログラム内でも異なる割り当てを使用することができる。（wikipediaより）

というわけです。

そして、1byteは8bitのことです。なので1byteあれば、2の8乗で256通りの状態を表すことができます。

基本はこのbyteを単位とするので、ここからキロバイト、メガバイト、ギガバイト、と大きくなっていきます。

少し注意してほしいのは、普通のキロ、メガ、ギガとは若干意味合いが異なるということですね。通常キロは10^3=1000を表しますが、キロバイトの場合のキロは2^10=1024を表します。これはよくないということで、今はキビバイト（KiB）で1024byteを表し、キロバイト（KB）で1000byteを表すような接頭語も出てはいるんですが、いまいち耳にしませんね。

余談ですが、C++でよく使う`int`型は（環境にも依ますが）4バイトなので、2の32乗=4294967296だけの数字を表せることになります。実際は`int`型は負の値も取るので下の補数表現に記載の通り、-2147483648〜2147483647までの数字を表すことができます。

</details>

</br>

<details><summary>2の補数表現</summary>

</br>

今回はあんまり必要ないので、気が向いたら書きます。補数表現と言っても色々あるみたですね。

</details>

</br>

## 同期式（クロック同期式）

同期式（クロック同期式）シリアル通信では、データを送る信号線の他に、クロックを送る専用の信号線を設けます。  

受信側ではそのクロックのタイミングに合わせてデータの信号を読み取れば、常に同期が取れた状態になります。例えばクロック信号の立ち上がりのタイミングでデータの一区切りを受け取れば良いですね。  

同期式シリアル通信は高効率でシンプルではあるものの、ノイズに弱いというデメリットもあるらしいです。  

<img src=https://github.com/laika90/b2multicopter/blob/document/documents/communication/images/01_02.png width="600px">   

([ラピステクノロジー](https://www.lapis-tech.com/jp/common/miconlp/tips/2-16-%e3%82%b7%e3%83%aa%e3%82%a2%e3%83%ab%e9%80%9a%e4%bf%a1%e3%81%a8%e3%81%af/)より)

## 非同期式（調歩同期式）

非同期式（調歩同期式）シリアル通信では、クロック信号は用いず、スタートビット（信号の開始を知らせる信号）が送られてから、そのスタートビットに合わせたタイミングや速度、周波数でデータの送受信を行う、というやり方です。

通信を終えたいときや、何も送る時がない場合は、ストップビットが送られ、受信側がそれをキャッチします。

<img src=https://github.com/laika90/b2multicopter/blob/document/documents/communication/images/01_03.png width="600px">  

([ラピステクノロジー](https://www.lapis-tech.com/jp/common/miconlp/tips/2-16-%e3%82%b7%e3%83%aa%e3%82%a2%e3%83%ab%e9%80%9a%e4%bf%a1%e3%81%a8%e3%81%af/)より)

prev | [next]()


